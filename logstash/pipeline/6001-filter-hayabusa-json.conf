# Hayabusa JSON/JSONL Parser
# SOF-ELK style: 6000-6999 range for log-type-specific parsers
# CRITICAL: EventID and RuleTitle MUST remain as strings (keyword type in ES)

filter {
  if [type] == "hayabusa-json" {
    # JSON is already parsed by codec in input
    # We just need to process timestamp and ensure proper field types

    # Parse timestamp - Hayabusa format: "yyyy-MM-dd HH:mm:ss.SSS +00:00"
    if [Timestamp] {
      date {
        match => [
          "Timestamp",
          "yyyy-MM-dd HH:mm:ss.SSS ZZ",
          "yyyy-MM-dd HH:mm:ss.SSS",
          "ISO8601"
        ]
        target => "@timestamp"
        timezone => "UTC"
        tag_on_failure => ["_dateparsefailure"]
      }
    }

    # Type conversions
    # CRITICAL: EventID must stay as string (keyword in Elasticsearch)
    # CRITICAL: RuleTitle must stay as string (keyword in Elasticsearch)
    mutate {
      convert => {
        "EventID" => "string"
        "RuleTitle" => "string"
        "RecordID" => "integer"
      }
    }

    # Strip whitespace from string fields
    if [Computer] {
      mutate { strip => ["Computer"] }
    }
    if [Channel] {
      mutate { strip => ["Channel"] }
    }
    if [EventID] {
      mutate { strip => ["EventID"] }
    }
    if [Level] {
      mutate { strip => ["Level"] }
    }
    if [RuleTitle] {
      mutate { strip => ["RuleTitle"] }
    }

    # Split MITRE fields if they contain multiple values (comma-separated or arrays)
    if [MitreTactics] {
      if [MitreTactics] !~ /^\[.*\]$/ {
        # If not already an array, split by comma
        mutate {
          split => { "MitreTactics" => "," }
        }
      }
    }

    if [MitreTags] {
      if [MitreTags] !~ /^\[.*\]$/ {
        mutate {
          split => { "MitreTags" => "," }
        }
      }
    }

    if [OtherTags] {
      if [OtherTags] !~ /^\[.*\]$/ {
        mutate {
          split => { "OtherTags" => "," }
        }
      }
    }

    # Create display-friendly fields for Kibana
    if [Details] {
      mutate {
        add_field => { "event_description" => "%{Details}" }
      }
    }

    if [ExtraFieldInfo] {
      mutate {
        add_field => { "extra_info" => "%{ExtraFieldInfo}" }
      }
    }

    # Remove unnecessary fields
    mutate {
      remove_field => ["host"]
    }

    # Tag parse failures for debugging
    if "_jsonparsefailure" in [tags] {
      mutate {
        add_tag => ["parse_error", "hayabusa_json_parse_error"]
        add_field => {
          "parse_error_type" => "json_parsing_failed"
        }
      }
    }

    # Add successfully parsed tag
    if "_jsonparsefailure" not in [tags] {
      mutate {
        add_tag => ["successfully_parsed"]
      }
    }
  }
}
