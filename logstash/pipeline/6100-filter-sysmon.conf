# Sysmon Parser (Example)
# SOF-ELK style: 6000-6999 range for log-type-specific parsers
# This is a basic example parser for Sysmon logs
# Extend this based on your specific Sysmon log format

filter {
  if [type] == "sysmon" or [type] == "sysmon-xml" {

    # If XML format, parse the XML structure
    if [type] == "sysmon-xml" {
      xml {
        source => "message"
        target => "sysmon_data"
        store_xml => false
        xpath => [
          "/Event/System/Provider/@Name", "provider_name",
          "/Event/System/EventID/text()", "event_id",
          "/Event/System/TimeCreated/@SystemTime", "event_time",
          "/Event/System/Computer/text()", "computer",
          "/Event/EventData/Data[@Name='UtcTime']/text()", "utc_time",
          "/Event/EventData/Data[@Name='ProcessGuid']/text()", "process_guid",
          "/Event/EventData/Data[@Name='ProcessId']/text()", "process_id",
          "/Event/EventData/Data[@Name='Image']/text()", "image",
          "/Event/EventData/Data[@Name='CommandLine']/text()", "command_line",
          "/Event/EventData/Data[@Name='User']/text()", "user",
          "/Event/EventData/Data[@Name='ParentProcessGuid']/text()", "parent_process_guid",
          "/Event/EventData/Data[@Name='ParentProcessId']/text()", "parent_process_id",
          "/Event/EventData/Data[@Name='ParentImage']/text()", "parent_image"
        ]
        tag_on_failure => ["_xmlparsefailure"]
      }

      # Parse the timestamp
      if [event_time] {
        date {
          match => ["event_time", "ISO8601"]
          target => "@timestamp"
        }
      } else if [utc_time] {
        date {
          match => ["utc_time", "ISO8601"]
          target => "@timestamp"
        }
      }

      # Convert numeric fields
      if [event_id] {
        mutate {
          convert => {
            "event_id" => "integer"
            "process_id" => "integer"
            "parent_process_id" => "integer"
          }
        }
      }
    }

    # Add Sysmon event type descriptions
    if [event_id] {
      translate {
        field => "event_id"
        destination => "event_description"
        dictionary => {
          "1" => "Process Creation"
          "2" => "Process Changed File Creation Time"
          "3" => "Network Connection"
          "4" => "Sysmon Service State Changed"
          "5" => "Process Terminated"
          "6" => "Driver Loaded"
          "7" => "Image Loaded"
          "8" => "CreateRemoteThread"
          "9" => "RawAccessRead"
          "10" => "ProcessAccess"
          "11" => "FileCreate"
          "12" => "RegistryEvent (Object create and delete)"
          "13" => "RegistryEvent (Value Set)"
          "14" => "RegistryEvent (Key and Value Rename)"
          "15" => "FileCreateStreamHash"
          "17" => "PipeEvent (Pipe Created)"
          "18" => "PipeEvent (Pipe Connected)"
          "19" => "WmiEvent (WmiEventFilter activity detected)"
          "20" => "WmiEvent (WmiEventConsumer activity detected)"
          "21" => "WmiEvent (WmiEventConsumerToFilter activity detected)"
          "22" => "DNSEvent (DNS query)"
          "23" => "FileDelete (File Delete archived)"
          "24" => "ClipboardChange (New content in clipboard)"
          "25" => "ProcessTampering (Process image change)"
          "26" => "FileDeleteDetected (File Delete logged)"
        }
        fallback => "Unknown Sysmon Event"
      }
    }

    # Tag specific Sysmon events for easy filtering
    if [event_id] == 1 {
      mutate { add_tag => ["process_creation"] }
    } else if [event_id] == 3 {
      mutate { add_tag => ["network_connection"] }
    } else if [event_id] == 7 {
      mutate { add_tag => ["image_loaded", "dll_load"] }
    } else if [event_id] == 10 {
      mutate { add_tag => ["process_access"] }
    } else if [event_id] == 11 {
      mutate { add_tag => ["file_creation"] }
    } else if [event_id] in [12, 13, 14] {
      mutate { add_tag => ["registry_event"] }
    } else if [event_id] == 22 {
      mutate { add_tag => ["dns_query"] }
    }

    # Add metadata
    mutate {
      add_field => {
        "[@metadata][index_prefix]" => "forensics-sysmon"
        "log_source" => "sysmon"
      }
    }

    # Tag parse failures
    if "_xmlparsefailure" in [tags] or "_grokparsefailure" in [tags] {
      mutate {
        add_tag => ["parse_error", "sysmon_parse_error"]
      }
    } else {
      mutate {
        add_tag => ["successfully_parsed"]
      }
    }
  }
}
