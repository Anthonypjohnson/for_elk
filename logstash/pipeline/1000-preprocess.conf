# Preprocessing filters for all forensic data
# SOF-ELK style: 1000-1999 range for preprocessing

filter {
  # Add source file metadata for tracking
  if [log][file][path] {
    mutate {
      add_field => {
        "[@metadata][source_file]" => "%{[log][file][path]}"
        "source_file" => "%{[log][file][path]}"
      }
    }
  }

  # Extract computer name from Hayabusa filename convention
  # Format: <COMPUTER_NAME>_hayabusa.csv or <COMPUTER_NAME>_hayabusa.jsonl
  if [type] in ["hayabusa-csv", "hayabusa-json"] {
    if [source_file] {
      grok {
        match => {
          "source_file" => "(?<computer_name>[^/]+)_hayabusa\.(csv|jsonl?|json)$"
        }
        tag_on_failure => []
      }
    }

    # Add forensic investigation metadata
    mutate {
      add_field => {
        "[@metadata][index_prefix]" => "hayabusa"
        "investigation_type" => "windows_event_log_analysis"
        "tool" => "hayabusa"
      }
    }
  }

  # Add timestamp for when log was ingested
  mutate {
    add_field => {
      "ingestion_timestamp" => "%{@timestamp}"
    }
  }

  # Add processing metadata
  mutate {
    add_field => {
      "[@metadata][processed_by]" => "forensics-elk-stack"
      "[@metadata][pipeline_version]" => "1.0"
    }
  }

  # Tag events by severity if Level field exists (for Hayabusa and Windows logs)
  if [Level] {
    if [Level] =~ /(?i)critical/ {
      mutate { add_tag => ["critical_severity"] }
    } else if [Level] =~ /(?i)high/ {
      mutate { add_tag => ["high_severity"] }
    } else if [Level] =~ /(?i)medium/ {
      mutate { add_tag => ["medium_severity"] }
    } else if [Level] =~ /(?i)low/ {
      mutate { add_tag => ["low_severity"] }
    } else if [Level] =~ /(?i)info/ {
      mutate { add_tag => ["info_severity"] }
    }
  }
}
