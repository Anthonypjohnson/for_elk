# Enrichment filters for forensic data
# SOF-ELK style: 8000-8999 range for enrichment
# Adds GeoIP, DNS resolution, and other contextual data

filter {
  # GeoIP enrichment for IP addresses (if available in logs)
  # Common IP field names in forensic logs

  # Source IP enrichment
  if [SourceIP] {
    geoip {
      source => "SourceIP"
      target => "source_geo"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }

  if [source_ip] {
    geoip {
      source => "source_ip"
      target => "source_geo"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }

  if [src_ip] {
    geoip {
      source => "src_ip"
      target => "source_geo"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }

  # Destination IP enrichment
  if [DestinationIP] {
    geoip {
      source => "DestinationIP"
      target => "dest_geo"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }

  if [destination_ip] {
    geoip {
      source => "destination_ip"
      target => "dest_geo"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }

  if [dst_ip] {
    geoip {
      source => "dst_ip"
      target => "dest_geo"
      tag_on_failure => ["_geoip_lookup_failure"]
    }
  }

  # Add index routing metadata based on log type
  if "hayabusa" in [tags] {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "hayabusa-%{+YYYY.MM.dd}"
      }
    }
  } else if "sysmon" in [tags] {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "forensics-sysmon-%{+YYYY.MM.dd}"
      }
    }
  } else if "powershell" in [tags] {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "forensics-powershell-%{+YYYY.MM.dd}"
      }
    }
  } else if "evtx" in [tags] {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "forensics-evtx-%{+YYYY.MM.dd}"
      }
    }
  } else if "network" in [tags] {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "forensics-network-%{+YYYY.MM.dd}"
      }
    }
  } else if "forensics" in [tags] {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "forensics-general-%{+YYYY.MM.dd}"
      }
    }
  } else {
    # Fallback index
    mutate {
      add_field => {
        "[@metadata][index_name]" => "forensics-unknown-%{+YYYY.MM.dd}"
      }
    }
  }

  # Add correlation ID for potential event linking
  # Useful for tracking related events across different log sources
  if [ProcessGuid] or [process_guid] {
    if [ProcessGuid] {
      mutate {
        add_field => { "correlation_id" => "%{ProcessGuid}" }
      }
    } else if [process_guid] {
      mutate {
        add_field => { "correlation_id" => "%{process_guid}" }
      }
    }
  }

  # Add investigation metadata timestamp
  ruby {
    code => "event.set('enrichment_timestamp', Time.now.utc.iso8601(3))"
  }

  # Tag events with potential indicators of compromise (basic examples)
  # These are simplified examples - expand based on your threat intelligence

  # Suspicious process names
  if [image] or [Image] {
    if [image] =~ /(?i)(mimikatz|psexec|procdump|nmap|metasploit|cobalt|empire)/ or
       [Image] =~ /(?i)(mimikatz|psexec|procdump|nmap|metasploit|cobalt|empire)/ {
      mutate {
        add_tag => ["suspicious_process", "potential_ioc"]
      }
    }
  }

  # Suspicious command line patterns
  if [command_line] or [CommandLine] {
    if [command_line] =~ /(?i)(invoke-mimikatz|invoke-expression|downloadstring|bypass|encoded|powershell -enc)/ or
       [CommandLine] =~ /(?i)(invoke-mimikatz|invoke-expression|downloadstring|bypass|encoded|powershell -enc)/ {
      mutate {
        add_tag => ["suspicious_commandline", "potential_ioc"]
      }
    }
  }

  # Known malicious IPs (example - replace with real threat intel)
  # This is just a placeholder - integrate with real threat intelligence feeds
  if [SourceIP] {
    if [SourceIP] in ["192.0.2.0", "198.51.100.0", "203.0.113.0"] {
      mutate {
        add_tag => ["malicious_ip", "potential_ioc", "threat_intel_match"]
      }
    }
  }
}
