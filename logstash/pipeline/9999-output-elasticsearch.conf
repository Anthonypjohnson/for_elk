# Output configuration - sends data to Elasticsearch
# SOF-ELK style: 9000-9999 range for outputs

output {
  # Route Hayabusa events to dedicated hayabusa index
  if "hayabusa" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "hayabusa-%{+YYYY.MM.dd}"

      # Apply Hayabusa index template
      template_name => "hayabusa"
      template => "/usr/share/logstash/templates/hayabusa-template.json"
      template_overwrite => true

      # Performance settings
      action => "index"
      timeout => 60

      # Error handling
      retry_on_conflict => 5
    }
  }

  # Route Sysmon events to dedicated sysmon index
  else if "sysmon" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "forensics-sysmon-%{+YYYY.MM.dd}"
      action => "index"
      timeout => 60
      retry_on_conflict => 5
    }
  }

  # Route PowerShell events
  else if "powershell" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "forensics-powershell-%{+YYYY.MM.dd}"
      action => "index"
      timeout => 60
      retry_on_conflict => 5
    }
  }

  # Route EVTX events
  else if "evtx" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "forensics-evtx-%{+YYYY.MM.dd}"
      action => "index"
      timeout => 60
      retry_on_conflict => 5
    }
  }

  # Route network logs
  else if "network" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "forensics-network-%{+YYYY.MM.dd}"
      action => "index"
      timeout => 60
      retry_on_conflict => 5
    }
  }

  # Route other forensic events
  else if "forensics" in [tags] {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "forensics-general-%{+YYYY.MM.dd}"
      action => "index"
      timeout => 60
      retry_on_conflict => 5
    }
  }

  # Fallback for any untagged events
  else {
    elasticsearch {
      hosts => ["https://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTIC_PASSWORD}"
      ssl_enabled => true
      ssl_verification_mode => "none"
      cacert => "/usr/share/logstash/config/certs/ca/ca.crt"

      index => "forensics-unknown-%{+YYYY.MM.dd}"
      action => "index"
      timeout => 60
      retry_on_conflict => 5
    }
  }

  # Debug output for parse failures (optional - comment out in production)
  # Writes failed events to a file for troubleshooting
  if "_grokparsefailure" in [tags] or
     "_csvparsefailure" in [tags] or
     "_jsonparsefailure" in [tags] or
     "_xmlparsefailure" in [tags] or
     "parse_error" in [tags] {
    file {
      path => "/usr/share/logstash/logs/parse-failures-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
  }

  # Optional: stdout output for debugging (comment out in production)
  # Uncomment the lines below to see events in Logstash logs
  # stdout {
  #   codec => rubydebug {
  #     metadata => true
  #   }
  # }
}
